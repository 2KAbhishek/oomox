#!/bin/bash -x
set -ueo pipefail


srcdir="/src"
app=OomoxAppImage
builddir=${srcdir}/${app}
appdir=${builddir}/${app}.appdir
mkdir -p ${appdir}


# Import AppImage functions:
cd ${builddir}/
#wget -q https://github.com/probonopd/AppImages/raw/master/functions.sh -O ./functions.sh
set +ueo pipefail
#. ./functions.sh
. ${srcdir}/functions.sh


# fetch oomox deps:
set -ueo pipefail
apt-get update
URLS=$(apt-get -y install --no-install-recommends --reinstall --print-uris \
    libgdk-pixbuf2.0-dev libxml2-utils python3-gi gtk2-engines-murrine bc sed zip inkscape imagemagick optipng parallel \
    sassc \
    libreadline6 make \
    python3.5-minimal python3-minimal libpython3.5-minimal libpython3.5-stdlib \
    libgtk-3-0 libpangoft2-1.0-0 libicu55 \
    libglib2.0-0 libgirepository-1.0-1 gir1.2-gtk-3.0 gir1.2-glib-2.0 gir1.2-atk-1.0 gir1.2-glib-2.0 \
    libibus-1.0-5 ibus-gtk3 \
    file \
    | cut -d "'" -f 2 | grep -e "^http")
cd ${builddir}
wget -c $URLS

cd ${appdir}
find ${builddir}/*.deb -exec dpkg -x {} . \; || true


set +ueo pipefail
echo "DEPS1::::::::::::::::::::"
copy_deps;
echo "DEPS2::::::::::::::::::::"
copy_deps;
echo "DEPS3::::::::::::::::::::"
copy_deps
echo "DEPS4::::::::::::::::::::"
copy_deps
echo "DEPS5::::::::::::::::::::"
copy_deps
#mv usr/include usr/include.tmp
#delete_blacklisted
#mv usr/include.tmp usr/include
rm './lib/x86_64-linux-gnu/libcom_err.so.2'
rm './lib/x86_64-linux-gnu/libcrypt.so.1'
rm './lib/x86_64-linux-gnu/libc.so.6'
rm './lib/x86_64-linux-gnu/libdl.so.2'
rm './lib/x86_64-linux-gnu/libexpat.so.1'
rm './lib/x86_64-linux-gnu/libgcc_s.so.1'
#rm './lib/x86_64-linux-gnu/libglib-2.0.so.0'
rm './lib/x86_64-linux-gnu/libgpg-error.so.0'
rm './lib/x86_64-linux-gnu/libkeyutils.so.1'
rm './lib/x86_64-linux-gnu/libm.so.6'
rm './lib/x86_64-linux-gnu/libnsl.so.1'
rm './lib/x86_64-linux-gnu/libnss_files.so.2'
rm './lib/x86_64-linux-gnu/libpthread.so.0'
rm './lib/x86_64-linux-gnu/libresolv.so.2'
rm './lib/x86_64-linux-gnu/librt.so.1'
rm './lib/x86_64-linux-gnu/libutil.so.1'
rm './lib/x86_64-linux-gnu/libz.so.1'
rm './usr/lib/x86_64-linux-gnu/libdrm.so.2'
rm './usr/lib/x86_64-linux-gnu/libdrm.so.2.4.0'
#rm './usr/lib/x86_64-linux-gnu/libfontconfig.so.1'
#rm './usr/lib/x86_64-linux-gnu/libfontconfig.so.1.9.0'
#rm './usr/lib/x86_64-linux-gnu/libgdk_pixbuf-2.0.so.0'
#rm './usr/lib/x86_64-linux-gnu/libgdk_pixbuf-2.0.so.0.3200.2'
#rm './usr/lib/x86_64-linux-gnu/libgio-2.0.so.0'
#rm './usr/lib/x86_64-linux-gnu/libgobject-2.0.so.0'
rm './usr/lib/x86_64-linux-gnu/libk5crypto.so.3'
rm './usr/lib/x86_64-linux-gnu/libp11-kit.so.0'
#rm './usr/lib/x86_64-linux-gnu/libpango-1.0.so.0'
#rm './usr/lib/x86_64-linux-gnu/libpango-1.0.so.0.3800.1'
#rm './usr/lib/x86_64-linux-gnu/libpangocairo-1.0.so.0'
#rm './usr/lib/x86_64-linux-gnu/libpangocairo-1.0.so.0.3800.1'
#rm './usr/lib/x86_64-linux-gnu/libpangoft2-1.0.so.0'
#rm './usr/lib/x86_64-linux-gnu/libpangoft2-1.0.so.0.3800.1'
rm './usr/lib/x86_64-linux-gnu/libstdc++.so.6'
rm './usr/lib/x86_64-linux-gnu/libX11.so.6'
rm './usr/lib/x86_64-linux-gnu/libX11.so.6.3.0'
rm './usr/lib/x86_64-linux-gnu/libxcb.so.1'
rm './usr/lib/x86_64-linux-gnu/libxcb.so.1.1.0'

rm ./usr/lib/x86_64-linux-gnu/libanl.so
rm ./usr/lib/x86_64-linux-gnu/libBrokenLocale.so
rm ./usr/lib/x86_64-linux-gnu/libcidn.so
rm ./usr/lib/x86_64-linux-gnu/libcrypt.so
rm ./usr/lib/x86_64-linux-gnu/libdl.so
rm ./usr/lib/x86_64-linux-gnu/libglib-2.0.so
rm ./usr/lib/x86_64-linux-gnu/libmvec.so
rm ./usr/lib/x86_64-linux-gnu/libnsl.so
rm ./usr/lib/x86_64-linux-gnu/libnss_compat.so
rm ./usr/lib/x86_64-linux-gnu/libnss_dns.so
rm ./usr/lib/x86_64-linux-gnu/libnss_files.so
rm ./usr/lib/x86_64-linux-gnu/libnss_hesiod.so
rm ./usr/lib/x86_64-linux-gnu/libnss_nisplus.so
rm ./usr/lib/x86_64-linux-gnu/libnss_nis.so
rm ./usr/lib/x86_64-linux-gnu/libpcre.so
rm ./usr/lib/x86_64-linux-gnu/libpng12.so.0
rm ./usr/lib/x86_64-linux-gnu/libresolv.so
rm ./usr/lib/x86_64-linux-gnu/librt.so
rm ./usr/lib/x86_64-linux-gnu/libthread_db.so
rm ./usr/lib/x86_64-linux-gnu/libutil.so
rm ./usr/lib/x86_64-linux-gnu/libz.so

#move_lib
set -ueo pipefail



#echo > ./pkgs.txt
#for lib in $(ldd ./usr/bin/inkscape | grep '=>' | awk '{print $3}' | grep "^/" ); do
    #dpkg -S $lib | cut -d: -f1 >> ./pkgs.txt
#done
#echo +++++++++++++++++++++++++
#cat ./pkgs.txt | sort -u
#echo +++++++++++++++++++++++++
#URLS=$(apt-get -y install --no-install-recommends --reinstall --print-uris \
    #$(cat ./pkgs.txt | sort -u | grep -v -e libc6) \
    #| cut -d "'" -f 2 | grep -e "^http")
#cd ${builddir}
#wget -c $URLS

#cd ${appdir}
#find ${builddir}/*.deb -exec dpkg -x {} . \; || true

# vim: ft=sh
